---
title: "Power or sample size" 
author: 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    social: menu
    source_code: embed
runtime: shiny
---
Probability mass functions
===

```{r global, include=FALSE}

  rm(list=ls())
  set.seed(6453)
    # for neg binomial analysis and correlated data generation
  library(ggplot2)
  
   
  library(gridExtra)
  library(tidyverse)
  
  library(Hmisc)
  lwd.=3             # used when plotting
  
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  # function to format decimals
  # https://stackoverflow.com/questions/3245862/format-numbers-to-significant-figures-nicely-in-r
  #~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
  formatz <- function(x){
    
    if (!is.na(x)  ) {
      
      formatC(signif(x,digits=5), digits=5,format="fg", flag="#",big.mark=",")
      
    }
    
  }
  
  formatz0 <- function(x){
    sprintf(x, fmt = '%s')  
  }
  formatz1 <- function(x){
    sprintf(x, fmt = '%#.1f')  
  }
  formatz2 <- function(x){
    sprintf(x, fmt = '%#.2f')  
  }
  formatz00 <- function(x){
    round(x,0) 
  }
  formatz3 <- function(x){
    sprintf(x, fmt = '%#.3f')  
  }
  formatz4 <- function(x){
    sprintf(x, fmt = '%#.4f')  
  }
  
 
 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
# start of app
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~

```

Column {.sidebar}
-----------------------------------------------------------------------

**Count data analysis is explored**

```{r tab1}

  

  # sliderInput('mu', 'Common  \u03BC', value=1.5,
  #               min = 1, max = 25, step=.5, ticks=F)
  # 
  # sliderInput('alpha_a', '\u03B1 for red curve', value = c(1.3),
  #               min = 0, max = 5 ,step=0.01, ticks=F)
  # 
  # sliderInput('alpha_b', '\u03B1 for dark blue curve', value = c(1.3),
  #               min = 0, max = 5 ,step=0.01, ticks=F)
  # 
  # sliderInput('alpha_d', '\u03B1 for purple curve', value = c(1.3),
  #               min = 0, max = 5 ,step=0.01, ticks=F)
  
  sliderInput('sims', 'Simulations (chart 2)', 50000,
                min = 50000, max = 500000,step=50000,ticks=F)
  
  sliderInput('x_range', 'Plot x-range', value = c(0,800),
          min = 0, max = 5000,step=100,ticks=F)
  
  sliderInput('y_range', 'Plot y-range', value = c(0,1),
          min = 0, max = 1,step=.05,ticks=F)

  # checkboxInput('perc','show stats on barplot', value=TRUE)
  
     br()
               # numericInput(inputId=("Decksize"),  
               #    label = tags$span(style="color:black;font-weight:bold;font-size: 16px;", 
               #    "No of cards of each suit in deck") ,
               #    value = 13, min=3,max=101, step=2)
               # 
               # numericInput(inputId=("swap"),   
               #        label = tags$span(style="color:black;font-weight:bold;font-size: 16px;", 
               #        "First card dealt") ,
               #        value = 10, min=1,max=101, step=1)
               #  
               #  numericInput(inputId=("sims"),   
               #         label = tags$span(style="color:black;font-weight:bold;font-size: 16px;", 
               #          "No of simulations") ,
               #           value = 1000, min=1000,max=1000000, step=1000) 
               # 
               #   

       
       
       splitLayout(
  textInput("alpha", div(h5(tags$span(style="color:blue", "alpha"))), 
            value= "0.05, 0.15,0.05, 0.05,0.05, 0.05"), 
                                         
                                       )
       
       
       
     #   
     #       splitLayout(
     #                           
     # textInput("beta",  div(h5(tags$span(style="color:blue", "beta"))),  
     #           value= "0.10, 0.10,0.10, 0.10,0.10, 0.10"),  )
     #       
     #       
     #        splitLayout(
     #                           
     #                   textInput("n",    div(h5(tags$span(style="color:blue",  "n"))),    
     #                             value= "100,100,100,100,100,100"), )
           
            splitLayout(
                               
                   textInput("p1",    div(h5(tags$span(style="color:blue", "p1"))),    
                             value= "0.2,0.2,0.2,0.2,0.2,0.2"),)
           
               splitLayout(
                               
                    textInput("p2",    div(h5(tags$span(style="color:blue", "p2"))),    
                              value= "0.1,0.12,0.13,0.15,0.4,0.05"),)
                                         
          
               splitLayout(
                               
                textInput("ro",    div(h5(tags$span(style="color:blue", "ro"))),   
                          value= "2,1,3,4,2,1"),)                                
                                        
  					 
                                         
       
       


       
xx <- reactive({
  
    A <-   (as.numeric(unlist(strsplit(input$alpha,","))))    
    
    A1 <- A[1]
    A2 <- A[2]
    A3 <- A[3]
    A4 <- A[5]
    A5 <- A[6]
    A6 <- A[6]
    

    # Ax <-   (as.numeric(unlist(strsplit(input$beta,","))))    
    # 
    # B1 <- Ax[1]
    # B2 <- Ax[2]
    # B3 <- Ax[3]
    # B4 <- Ax[4]
    # B5 <- Ax[5]
    # B6 <- Ax[6] 
    # 
    # 
    # Ay<-   (as.numeric(unlist(strsplit(input$n,","))))    
    # 
    # N1 <- Ay[1]
    # N2 <- Ay[2]
    # N3 <- Ay[3]
    # N4 <- Ay[4]
    # N5 <- Ay[5]
    # N6 <- Ay[6] 

    Az<-   (as.numeric(unlist(strsplit(input$p1,","))))    
    
    P1 <- Az[1]
    P2 <- Az[2]
    P3 <- Az[3]
    P4 <- Az[4]
    P5 <- Az[5]
    P6 <- Az[6] 

    Aa<-   (as.numeric(unlist(strsplit(input$p2,","))))    
    
    P1B <- Aa[1]
    P2B <- Aa[2]
    P3B <- Aa[3]
    P4B <- Aa[4]
    P5B <- Aa[5]
    P6B <- Aa[6] 


    Ab<-   (as.numeric(unlist(strsplit(input$ro,","))))    
    
    R1 <- Ab[1]
    R2 <- Ab[2]
    R3 <- Ab[3]
    R4 <- Ab[4]
    R5 <- Ab[5]
    R6 <- Ab[6] 
               
#     ## Function to calculate n1 and n2 based on k and S
# calculate_n1_n2 <- function(k, S) {
#     n2 <- S / (k + 1)
#     n1 <- k * n2
#     return(c(n1 = n1, n2 = n2))
# }
# 
# # Example usage with k = 3 and S = 200
# k <- 1
# S <- 200
# 
#  
    
    sample_sizes <- seq(10, input$x_range[2], by = 10)
    
power_values_1 <- bpower(n1 = sample_sizes/(R1+1), 
                         n2 = R1* sample_sizes/(R1+1), p1 = P1, p2 =  P1B, alpha = A1)

power_values_2 <- bpower(n1 = sample_sizes/(R2+1), 
                         n2 = R2* sample_sizes/(1+R2), p1 = P2, p2 =  P2B, alpha = A2)

power_values_3 <- bpower(n1 = sample_sizes/(R3+1), 
                         n2 = R3* sample_sizes/(1+R3), p1 = P3, p2 =  P3B, alpha = A3)
power_values_4 <- bpower(n1 = sample_sizes/(R4+1), 
                         n2 = R4* sample_sizes/(1+R4), p1 = P4, p2 =  P4B, alpha = A4)
power_values_5 <- bpower(n1 = sample_sizes/(R5+1), 
                         n2 = R5* sample_sizes/(1+R5), p1 = P5, p2 =  P5B, alpha = A5)
power_values_6 <- bpower(n1 = sample_sizes/(R6+1), 
                         n2 = R6* sample_sizes/(1+R6), p1 = P6, p2 =  P6B, alpha = A6)
 
 
 
#https://stackoverflow.com/questions/56646451/how-to-create-variable-names-in-a-function-with-paste?noredirect=1&lq=1
# Create a data frame containing the sample sizes and power values
# power_df <- data.frame(sample_size = sample_sizes, 
#                        setNames(list(power_values_1), paste("p1",P1,"p2",P1B, "alpha",A1, sep="_")),
#                        setNames(list(power_values_2), paste("p1",P2,"p2",P2B, "alpha",A2, sep="_")),
#                          setNames(list(power_values_3), paste("p1",P3,"p2",P3B, "alpha",A3, sep="_")),
#                          setNames(list(power_values_4), paste("p1",P4,"p2",P4B, "alpha",A4, sep="_")),
#                          setNames(list(power_values_5), paste("p1",P5,"p2",P5B, "alpha",A5, sep="_")),
#                         setNames(list(power_values_6), paste("p1",P6,"p2",P6B, "alpha",A6, sep="_"))
# )

 
power_df <- data.frame(sample_size = sample_sizes, 
                         setNames(list(power_values_1), paste("x_1"  ,P1,P1B, A1, sep="_")),
                         setNames(list(power_values_2), paste("x_2"  ,P2,P2B, A2, sep="_")),
                         setNames(list(power_values_3), paste("x_3"  ,P3,P3B, A3, sep="_")),
                         setNames(list(power_values_4), paste("x_4"  ,P4,P4B, A4, sep="_")),
                         setNames(list(power_values_5), paste("x_5"  ,P5,P5B, A5, sep="_")),
                         setNames(list(power_values_6), paste("x_6"  ,P6,P6B, A6, sep="_"))
)

 
# s <- str_split(z, "_")
# A <- s[[1]][3]
# B <- s[[1]][4]
# C <- s[[1]][5]
# 
# phrase <- paste("p1=",A,"p2=",B,"alpha="C)



x <- reshape2::melt(power_df, id.vars="sample_size")


xx <- stringr::str_split(x$variable, "_")

 # https://stackoverflow.com/questions/41336606/accessing-element-of-a-split-string

x$A <- sapply( xx, "[", 3 )
x$B <- sapply( xx, "[", 4 )
x$C <- sapply( xx, "[", 5 ) 

x$phrase <- paste("p1=",x$A,"p2=",x$B,"\nalpha=",x$C)
x$A <- x$B <- x$C <- x$s <- NULL

x$variable <- rep(1:6, each=length(sample_sizes)) 




#x$ratio  <- "1:1"
    
    
  x$variable <- factor(x$variable)
  
  library(dplyr)
  
  x$tag <-  paste(as.character(x$variable),as.character(x$phrase))

# using filter(), top_n() or slice()

#  tags <-
#      x %>% 
#       group_by(variable) %>% 
#       filter(row_number()==1) %>% select(phrase)
# 
# tags$i <- paste(as.character(tags$id),as.character(tags$phrase))

    # return(list(  
    #   
    #   A1=A1, A2=A2,A3=A3,A4=A4,A5,A5,A6=A6,
    #   B1=B1,B2=B2,B3=B3,B4=B4,B5=B5, B6=B6,
    #   N1=N1,N2=N2,N3=N3,N4=N4,N5=N5,N6=N6,
    #   P1=P1,P2=P2,P3=P3,P4=P4,P5=P5,P6=P6,
    #   P1B=P1B,P2B=P2B,P3B=P3B,P4B=P4B,P5B=P5B,P6B=P6B,
    #    R1=R1,R2=R2,R3=R3,R4=R4,R5=R5,R6=R6
    #  ))
    
    
    return(list(  
      
      x=x# , tags= as.character(tags$i)
     ))    



})

                


       
# calc <- reactive({
# 
# 
#   
#   
# sample_sizes <- seq(10, 800, by = 10)
# power_values_1 <- bpower(n1 = sample_sizes*xx()$R1, n2 = sample_sizes*(1-xx()$R1), p1 = xx()$P1, p2 =  xx()$P1B, alpha = xx()$A1)
# power_values_2 <- bpower(n1 = sample_sizes*xx()$R2, n2 = sample_sizes*(1-xx()$R2), p1 = xx()$P2, p2 =  xx()$P2B, alpha = xx()$A2)
#  
# 
# power_values_3 <-  bpower(n1 = sample_sizes*xx()$R3, n2 = sample_sizes*(1-xx()$R3), p1 = xx()$P3, p2 =  xx()$P3B, alpha = xx()$A3)
# power_values_4 <-  bpower(n1 = sample_sizes*xx()$R4, n2 = sample_sizes*(1-xx()$R4), p1 = xx()$P4, p2 =  xx()$P4B, alpha = xx()$A4)
# 
# power_values_5 <-  bpower(n1 = sample_sizes*xx()$R5, n2 = sample_sizes*(1-xx()$R5), p1 = xx()$P5, p2 =  xx()$P5B, alpha = xx()$A5)
# power_values_6 <-  bpower(n1 = sample_sizes*xx()$R6, n2 = sample_sizes*(1-xx()$R6), p1 = xx()$P6, p2 =  xx()$P6B, alpha = xx()$A6)
# 
# # Create a data frame containing the sample sizes and power values
# power_df <- data.frame(sample_size = sample_sizes, 
#                        power_1 = power_values_1, 
#                        power_2 = power_values_2,
#                        power_3 = power_values_3, 
#                        power_4 = power_values_4,
#                        power_5 = power_values_5, 
#                        power_6 = power_values_6
# )
# 
#  
# 
# 
# 
# x <- reshape2::melt(power_df, id.vars="sample_size")
#  
# 
# x$ratio  <- "1:1"
#  
# 
#  
# 
#           
#     
#     return(list(  
#     x=x
#       
#      ))
#     
# 
# })
# 












  

```

$\alpha$ takes on positive rational values, rarely above 4 (ref 11 page 190). Values of $\alpha$ greater than 2 usually indicate that there is substantial over-dispersion.

When $\alpha$ approaches 0, k approaches infinity and Poisson emerges (move red $\alpha$ slider to 0).

When $\alpha$ > 1, k < 1 leads to over dispersed data.

$\alpha$ = 1/k ; k = 1/ $\alpha$ see next tab.
 

Column {data-width=600, height=600}
-----------------------------------------------------------------------
### Chart 1


```{r tab1 plot1}

renderPlot({
  
  p =      xx()$x
  
 #  tag = xx()$tags
  # tags <- as.character(phrase$phrase2)
  
 # p$variable<-sub("_", "_ \n ", p$variable)  
  
  skips <- ifelse(input$x_range[2] <= 1000, 50,
                ifelse(input$x_range[2] > 1000 & input$x_range[2] < 3000 ,200
                       ,  500))
   
  #https://stackoverflow.com/questions/18515588/dynamic-legend-labels-in-ggplot2
  legendlabels <- data.frame(
                    'stadtland'= unique(p$tag),
                    stringsAsFactors=FALSE)
  
  
  all <-ggplot(p, aes(x = sample_size, y = value, #linetype=ratio,
                    #group = interaction(ratio, variable),
                    group=variable,
                    colour = variable)) +
  geom_line() +
    
    scale_color_manual( labels=legendlabels[['stadtland']], # c("a","b","c","d","e","f"),
                        values = c("red", "green", "blue", "purple","black","orange")) +
                                
  #), values = c("red", "green", "blue", "purple","black","orange"))
    
# scale_color_manual(labels = c("p1=0.20, p2=0.15", "p1=0.20, p2=0.10", 
 #                               "p1=0.30, p2=0.25", "p1=0.30, p2=0.20" ,
  #                              "p1=0.25, p2=0.20", "p1=0.25, p2=0.15" 
                                
  #), values = c("red", "green", "blue", "purple","black","orange")) +
  
 # scale_linetype_manual(values=c("solid",   "dashed")) +
  
  
  #  geom_vline(xintercept = seq(0, 700, by = 50),  col = "gray", linetype = "solid",  linewidth = .25) +
  #   geom_hline(yintercept = seq(0, 1, by = 0.1), col = "gray", linetype = "solid",  linewidth = .25) +
  
  scale_y_continuous(breaks = seq(0, 1, by = 0.1),  limits = c(0,1)) +
  scale_x_continuous(breaks = seq(0,input$x_range[2],skips), limits = c(0,input$x_range[2])) +
  theme_bw() +
  #  theme(legend.position="none") +
  theme( 
    plot.title=element_text(size = 12), plot.margin = unit(c(5.5,12,5.5,5.5), "pt"),
    legend.text=element_text(size=10),
    legend.title=element_text(size=10),
    legend.position="right",
    
    legend.key.size = unit(12, "pt"),  # legend horizontal bar length
    
    axis.text.x  = element_text(size=10),
    axis.text.y  = element_text(size=10),
    axis.line.x = element_line(color="black"),
    axis.line.y = element_line(color="black"),
    plot.caption=element_text(hjust = 0, size = 7),
    strip.text.x = element_text(size = 16, colour = "black", angle = 0),
    axis.title.y = element_text(size = rel(1), angle = 90),
    axis.title.x = element_text(size = rel(1), angle = 0 ),
    
    
    strip.background = element_rect(colour = "black", fill = "white"),
    panel.background = element_rect(fill = 'white', colour = 'white'),
    plot.background = element_rect(fill = 'white', colour = 'white')
  ) +
  
  
  labs(y="Power", x = 'Total Sample Size', color = "Population probabilities", linetype="Ratio p1:p2" )+
  labs(caption = paste("- Alpha the type I assertion probability = 0.05 two sided. Ratio 1:2 pertains to larger sample in experimental arm.\n- Uses method of Fleiss, Tytun, and Ury (but without the continuity correction) to estimate the power (or the sample size to achieve a given power) of a two-sided test for the difference in two proportions. \n- Fleiss JL, Tytun A, Ury HK (1980): A simple approximation for calculating sample sizes for comparing independent proportions. Biometrics 36:343–6.\n" )) +
  ggtitle(paste0("Endpoint option 1. Power (or sample size) for difference in two proportions for evaluation of treatment effect on mortality rate.") ) 


#https://stackoverflow.com/questions/15059093/ggplot2-adjust-the-symbol-size-in-legends
all <- all + guides(color = guide_legend(override.aes = list(linewidth = 3 )))

print(all)
  
  
  
  
  
  
  
  
  
  
 }
)

``` 
### Chart 2

```{r, tab1 plot2}
 

```  

References
====
```{r, refs}
 
    tags$a(href = "https://stats.stackexchange.com/questions/71194/fitting-a-poisson-distribution-with-lme4-and-nlme", target="_blank",
           tags$span(style="color:blue", "[1] Poisson with lme4 and nlme"),) 
    div(p(" "))
    tags$a(href = "https://stats.stackexchange.com/questions/27869/fitting-a-poisson-glm-mixed-model-with-a-random-slope-and-intercept",target="_blank",
           tags$span(style="color:blue", "[2] Mixed model Poisson"),)
    div(p(" "))
    tags$a(href = "https://stackoverflow.com/questions/6044800/adding-greek-character-to-axis-title", target="_blank",
           tags$span(style="color:blue", "[3] Adding Greek characters - shiny"),)
    div(p(" "))
    tags$a(href = "https://stackoverflow.com/questions/52225348/shiny-flexdashboard-reference-object-in-new-tabset#52225733", target="_blank",
           tags$span(style="color:blue", "[4] Reference object in new tab - shiny"),)  
    div(p(" "))
    tags$a(href = "https://journals.sagepub.com/doi/pdf/10.1177/1536867X1201200202", target="_blank",
           tags$span(style="color:blue", "[5] What hypotheses do “nonparametric” two-group tests actually test?"),) 
    div(p(" "))
    tags$a(href = "https://www.google.co.uk/books/edition/Discrete_Data_Analysis_with_R/danODwAAQBAJ?hl=en",target="_blank",
           tags$span(style="color:blue", "[6] Discrete Data Analysis with R Visualization and Modeling Techniques for Categorical and Count Data"),) 
    div(p(" "))
    tags$a(href = "https://www.galitshmueli.com/system/files/ASMB_901_rev.pdf",target="_blank",
           tags$span(style="color:blue", "[7] On generating multivariate Poisson data in management science applications"),) 
    div(p(" "))
    tags$a(href = "https://thomasward.com/simulating-correlated-data/",target="_blank",
           tags$span(style="color:blue", "[8] Simulating correlated data"),) 
    div(p(" "))
    tags$a(href = "https://www.rdocumentation.org/packages/simstudy/versions/0.3.0", target="_blank", 
           tags$span(style="color:blue", "[9] package simstudy for simulating correlated data, not used but interesting"),) 
    div(p(" "))
    tags$a(href = "https://www.rdocumentation.org/packages/SimCorrMix/versions/0.1.1/topics/SimCorrMix",target="_blank", 
           tags$span(style="color:blue", "[10] package SimCorrMix for simulating correlated data, not used but interesting"),) 
    div(p(" "))
    tags$a(href = "https://www.amazon.com/Negative-Binomial-Regression-Joseph-Hilbe/dp/0521198151",target="_blank", 
           tags$span(style="color:blue", "[11] Negative Binomial Regression 2nd Edition by Joseph M. Hilbe"),) 
    div(p(" "))
    tags$a(href = "https://www.amazon.co.uk/Discrete-Data-Analysis-Visualization-Categorical/dp/149872583X",target="_blank", 
           tags$span(style="color:blue", "[12] Discrete Data Analysis with R: Visualization and Modeling Techniques for Categorical and Count Data, Michael Friendly, David Meyer"),) 
    div(p(" "))
    tags$a(href = "https://bmcmedresmethodol.biomedcentral.com/track/pdf/10.1186/s12874-015-0023-0.pdf",target="_blank",
           tags$span(style="color:blue", "[13] Sample size calculations for skewed distributions - see canned power tab"),) 
    div(p(" "))
      tags$a(href = "https://pubmed.ncbi.nlm.nih.gov/17230434/", target="_blank",
           tags$span(style="color:blue", "[14] Analysis of exacerbation rates in asthma and chronic obstructive pulmonary disease: example from the TRISTAN study - see canned power tab "),) 
    div(p(" "))
    tags$a(href = "https://stats.stackexchange.com/questions/10419/what-is-theta-in-a-negative-binomial-regression-fitted-with-r", target="_blank",
           tags$span(style="color:blue", "[15] J Hilbe explains what is reported by R's negative binomial model output "),) 
    div(p(" "))
     tags$a(href = "https://onlinelibrary.wiley.com/doi/abs/10.1002/sim.5947", target="_blank",
           tags$span(style="color:blue", "[16] H. Zhu and H. Lakkis (2014). Sample size calculation for comparing two negative binomial rates, Statistics in Medicine, 33:376-387"),) 
     div(p(" "))
     tags$a(href = "https://www.ejobrien.com/", target="_blank",
           tags$span(style="color:blue", "[17] Sixty percent of the time it works every time <- more apps here!"),) 
    div(p(" "))
  tags$hr()                        

```